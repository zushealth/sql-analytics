WITH colo_obs AS (
    SELECT DISTINCT
        UPID,
        EFFECTIVE_START,
        EFFECTIVE_END,
        CASE
            WHEN CODE_LOINC IN ('12503-9', '12504-7', '14563-1', '14564-9', '14565-6', '159094', '27396-1', '27401-9', '27925-7', '27926-5', '29771-3', '56490-6', '56491-4', '57905-2', '58453-2', '80372-6') THEN 'FOBT'
            WHEN CODE_LOINC IN ('77353-1', '77354-9') THEN 'sDNA FIT Test'
            WHEN CODE_LOINC IN ('60515-4', '72531-7', '79069-1', '79071-7', '79101-2', '82688-3') THEN 'CT Colonography'
        END AS CARE_TYPE,
        LISTAGG(DISTINCT COALESCE(VALUE_STRING, VALUE_QUANTITY_VALUE || ' ' || VALUE_QUANTITY_UNIT), ', ') AS RESULT,
        LISTAGG(DISTINCT OIC.CODE, ', ') AS INTERPRETATION_CODE,
        LISTAGG(DISTINCT OIC.DISPLAY, ', ') AS INTERPRETATION_DISPLAY,
        MAX(CASE WHEN DATA_SOURCE IN ('carequality', 'commonwell') THEN TRUE END) AS EHR_DOCUMENTATION,
        LISTAGG(DISTINCT O.ENCOUNTER_ID, ', ') AS ENCOUNTER_IDs,
        LISTAGG(DISTINCT E.ENC_TYPE_CODE, ', ') AS ENCOUNTER_TYPE,
    FROM OBSERVATION AS O
    LEFT JOIN OBSERVATION_INTERPRETATION_CODING AS OIC ON O.OBSERVATION_INTERPRETATION_ID = OIC.OBSERVATION_INTERPRETATION_ID
    LEFT JOIN (
        SELECT
            ID,
            ETC.CODE AS ENC_TYPE_CODE
        FROM ENCOUNTER AS E
        LEFT JOIN ENCOUNTER_TYPE_CODING AS ETC ON E.ENCOUNTER_TYPE_ID = ETC.ENCOUNTER_TYPE_ID
        WHERE ETC.USER_SELECTED IS NOT NULL
    ) AS E ON E.ID = O.ENCOUNTER_ID
    WHERE CODE_LOINC IN ('12503-9', '12504-7', '14563-1', '14564-9', '14565-6', '159094', '27396-1', '27401-9', '27925-7', '27926-5', '29771-3', '56490-6', '56491-4', '57905-2', '58453-2', '80372-6', '77353-1', '77354-9', '60515-4', '72531-7', '79069-1', '79071-7', '79101-2', '82688-3')
    AND STATUS NOT IN ('cancelled', 'entered-in-error')
    AND VALUE_QUANTITY_VALUE IS NOT NULL
    AND (E.ENC_TYPE_CODE = 'AMB' OR E.ENC_TYPE_CODE IS NULL)
    GROUP BY 1, 2, 3, 4
),

colo_pro AS (
    SELECT DISTINCT
        UPID,
        PERFORMED_START AS EFFECTIVE_START,
        PERFORMED_END AS EFFECTIVE_END,
        CASE
            WHEN COALESCE(CODE_SNOMED, CODE_CPT, CODE_HCPCS) IN ('396226005', '425634007', '44441009', '45330', '45331', '45332', '45333', '45334', '45335', '45337', '45338', '45340', '45341', '45342', '45346', '45347', '45349', '45350', '841000119107', 'G0104') THEN 'Flexible Sigmoidoscopy'
            WHEN COALESCE(CODE_SNOMED, CODE_CPT, CODE_HCPCS) IN ('1209098000', '12350003', '174158000', '174185007', '235150006', '235151005', '25732003', '275251008', '302052009', '34264006', '367535003', '44388', '44389', '44390', '44391', '44392', '44393', '44394', '44397', '443998000', '44401', '44402', '44403', '44404', '44405', '44406', '44407', '44408', '444783004', '446521004', '446745002', '447021001', '45355', '45378', '45379', '45380', '45381', '45382', '45383', '45384', '45385', '45386', '45387', '45388', '45389', '45390', '45391', '45392', '45393', '45398', '709421007', '710293001', '711307001', '713154003', '73761001', '8180007', '851000119109', 'G0105', 'G0121') THEN 'Colonoscopy'
        END AS CARE_TYPE,
        'NA' AS RESULT,
        '' AS INTERPRETATION_CODE,
        '' AS INTERPRETATION_DISPLAY,
        MAX(CASE WHEN P.DATA_SOURCE IN ('carequality', 'commonwell') THEN TRUE END) AS EHR_DOCUMENTATION,
        LISTAGG(DISTINCT P.ENCOUNTER_ID, ', ') AS ENCOUNTER_IDs,
        LISTAGG(DISTINCT E.ENC_TYPE_CODE, ', ') AS ENCOUNTER_TYPE,
    FROM PROCEDURE AS P
    LEFT JOIN (
        SELECT
            ID,
            ETC.CODE AS ENC_TYPE_CODE
        FROM ENCOUNTER AS E
        LEFT JOIN ENCOUNTER_TYPE_CODING AS ETC ON E.ENCOUNTER_TYPE_ID = ETC.ENCOUNTER_TYPE_ID
        WHERE ETC.USER_SELECTED IS NOT NULL
    ) AS E ON E.ID = P.ENCOUNTER_ID
    WHERE COALESCE(CODE_SNOMED, CODE_CPT, CODE_HCPCS) IN ('396226005', '425634007', '44441009', '45330', '45331', '45332', '45333', '45334', '45335', '45337', '45338', '45340', '45341', '45342', '45346', '45347', '45349', '45350', '841000119107', 'G0104', '1209098000', '12350003', '174158000', '174185007', '235150006', '235151005', '25732003', '275251008', '302052009', '34264006', '367535003', '44388', '44389', '44390', '44391', '44392', '44393', '44394', '44397', '443998000', '44401', '44402', '44403', '44404', '44405', '44406', '44407', '44408', '444783004', '446521004', '446745002', '447021001', '45355', '45378', '45379', '45380', '45381', '45382', '45383', '45384', '45385', '45386', '45387', '45388', '45389', '45390', '45391', '45392', '45393', '45398', '709421007', '710293001', '711307001', '713154003', '73761001', '8180007', '851000119109', 'G0105', 'G0121')
    GROUP BY 1, 2, 3, 4, 5, 6
),

colec AS (
    SELECT DISTINCT
        UPID,
        PERFORMED_START AS EFFECTIVE_START,
        PERFORMED_END AS EFFECTIVE_END,
        MAX(CASE WHEN P.DATA_SOURCE IN ('carequality', 'commonwell') THEN TRUE END) AS EHR_DOCUMENTATION,
        LISTAGG(DISTINCT P.ENCOUNTER_ID, ', ') AS ENCOUNTER_IDs,
        LISTAGG(DISTINCT E.ENC_TYPE_CODE, ', ') AS ENCOUNTER_TYPE,
    FROM PROCEDURE AS P
    LEFT JOIN (
        SELECT
            ID,
            ETC.CODE AS ENC_TYPE_CODE
        FROM ENCOUNTER AS E
        LEFT JOIN ENCOUNTER_TYPE_CODING AS ETC ON E.ENCOUNTER_TYPE_ID = ETC.ENCOUNTER_TYPE_ID
        WHERE ETC.USER_SELECTED IS NOT NULL
    ) AS E ON E.ID = P.ENCOUNTER_ID
    WHERE COALESCE(CODE_SNOMED, CODE_CPT, CODE_HCPCS) IN ('44150', '44151', '44152', '44153', '44155', '44156', '44157', '44158', '44210', '44211', '44212', '0DTE0ZZ', '0DTE4ZZ', '0DTE7ZZ', '0DTE8ZZ', '45.81', '45.82', '45.83', '456004', '26390003', '31130001', '36192008', '44751009', '80294005', '303401008', '307666008', '307667004', '307669001', '713165008', '787108001', '787109009', '787874000', '787875004', '787876003', '858579005')
    GROUP BY 1, 2, 3
),

cancer AS (
    SELECT DISTINCT
        UPID,
        FIRST_VALUE(RECORDED_DATE) OVER (PARTITION BY UPID ORDER BY RECORDED_DATE) AS FIRST_RECORDED,
        LAST_VALUE(RECORDED_DATE) OVER (PARTITION BY UPID ORDER BY RECORDED_DATE) AS LAST_RECORDED
    FROM CONDITION AS C
    WHERE COALESCE(CODE_ICD10CM, CODE_SNOMED) IN ('C18.0', 'C18.1', 'C18.2', 'C18.3', 'C18.4', 'C18.5', 'C18.6', 'C18.7', 'C18.8', 'C18.9', 'C19', 'C20', 'C21.2', 'C21.8', 'C78.5', 'Z85.038', 'Z85.048', '153.0', '153.1', '153.2', '153.3', '153.4', '153.5', '153.6', '153.7', '153.8', '153.9', '154.0', '154.1', '197.5', 'V10.05', 'V10.06', '93683002', '93761005', '93771007', '93826009', '93980002', '93984006', '94006002', '94072004', '94105000', '94179005', '94260004', '94271003', '94328005', '94509004', '94513006', '94538001', '94604000', '94643001', '109838007', '109839004', '187757001', '187760008', '254582000', '254586002', '269533000', '269544008', '276822007', '285312008', '285611007', '285612000', '301756000', '312111009', '312112002', '312113007', '312114001', '312115000', '314965007', '314966008', '315058005', '363351006', '363406005', '363407001', '363408006', '363409003', '363410008', '363412000', '363413005', '363414004', '363510005', '369448007', '369449004', '369450004', '369451000', '369452007', '369453002', '369454008', '369455009', '369456005', '369457001', '369458006', '369459003', '369460008', '369461007', '395705003', '422375001', '422581008', '422985007', '425178004', '425213009', '429084005', '429699009', '443488001', '447886005', '448994001', '449218003', '713573006', '721695008', '721696009', '721697000', '721698005', '721699002', '721700001', '721701002', '726654006', '737058005', '766979005', '766981007', '1156783003', '1156788007', '1156795003', '1156797006', '1163568002', '1197354001', '1197355000', '1197359006', '1204448006', '1259403004', '1259404005', '1259405006', '1259406007', '1259407003', '1259432001', '1259436003', '1259437007', '1701000119104', '96281000119107', '96981000119102', '123691000119104', '123701000119104', '123721000119108', '130381000119103', '133751000119102', '184881000119106', '286771000119106', '286791000119107', '681601000119101', '681651000119102', '10987871000119109', '16636051000119105', '16636101000119105')
)
SELECT DISTINCT
    P.UPID,
    colo_obs.* EXCLUDE UPID
FROM PATIENT AS P
LEFT JOIN colo_obs ON P.UPID = colo_obs.UPID

UNION ALL

SELECT DISTINCT
    P.UPID,
    colo_pro.* EXCLUDE UPID
FROM PATIENT AS P
LEFT JOIN colo_pro ON P.UPID = colo_pro.UPID
WHERE DATEDIFF(year, P.BIRTH_DATE, CURRENT_DATE()) BETWEEN 45 AND 75
AND P.UPID NOT IN (SELECT DISTINCT UPID FROM cancer)
AND P.UPID NOT IN (SELECT DISTINCT UPID FROM colec)